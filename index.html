<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>BASI JAPAN 組織図</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Noto+Sans+JP:wght@300;400;500&display=swap');

  :root {
    --red: #E8272A;
    --red-dark: #c0191c;
    --red-light: #fff0f0;
    --bg: #f7f7f7;
    --paper: #ffffff;
    --ink: #1a1a1a;
    --muted: #888;
    --line: #e8e8e8;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    font-family: 'Noto Sans JP', sans-serif;
    font-weight: 300;
    color: var(--ink);
    min-height: 100vh;
    padding: 0 0 80px;
  }

  /* Header */
  header {
    background: var(--red);
    padding: 24px 32px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    flex-wrap: wrap;
  }

  .header-left { display: flex; align-items: center; gap: 16px; }

  .logo-mark {
    width: 48px;
    height: 48px;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .logo-mark svg { width: 32px; height: 32px; }

  .header-titles h1 {
    font-family: 'Montserrat', sans-serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.15em;
    color: white;
    line-height: 1;
  }

  .header-titles p {
    font-size: 11px;
    letter-spacing: 0.2em;
    color: rgba(255,255,255,0.7);
    text-transform: uppercase;
    margin-top: 4px;
    font-family: 'Montserrat', sans-serif;
  }

  .save-pill {
    font-size: 11px;
    letter-spacing: 0.05em;
    color: white;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 20px;
    padding: 5px 14px;
    transition: all 0.3s;
    font-family: 'Montserrat', sans-serif;
  }

  .save-pill.saved { background: rgba(255,255,255,0.35); border-color: white; }

  /* Legend */
  .legend-bar {
    background: var(--paper);
    border-bottom: 1px solid var(--line);
    padding: 10px 32px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* Org grid */
  .org {
    max-width: 1140px;
    margin: 28px auto;
    padding: 0 24px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    align-items: start;
  }

  /* Branch card */
  .branch {
    background: var(--paper);
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid var(--line);
  }

  .branch-header {
    padding: 16px 20px 14px;
    border-bottom: 3px solid var(--red);
    background: var(--paper);
  }

  .branch-tag {
    display: inline-block;
    font-size: 9px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--red);
    background: var(--red-light);
    padding: 2px 8px;
    border-radius: 2px;
    margin-bottom: 6px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
  }

  .branch-name {
    font-family: 'Montserrat', sans-serif;
    font-size: 18px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.05em;
  }

  .branch-count { font-size: 10px; color: var(--muted); margin-top: 5px; }

  /* Section */
  .section { padding: 12px 20px; border-bottom: 1px solid var(--line); }
  .section:last-child { border-bottom: none; }

  .section-label {
    font-size: 9px;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'Montserrat', sans-serif;
    font-weight: 600;
  }
  .section-label::after { content: ''; flex: 1; height: 1px; background: var(--line); }

  .members { display: flex; flex-direction: column; gap: 3px; }

  .member {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.12s;
    border: 1px solid transparent;
  }
  .member:hover { background: var(--bg); }
  .member:active { background: var(--red-light); }

  .member-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Montserrat', sans-serif;
    font-size: 11px; font-weight: 600;
    flex-shrink: 0; letter-spacing: 0.03em;
  }

  .t-staff .member-avatar { background: var(--red-light); color: var(--red); }
  .t-part .member-avatar { background: #fff8ee; color: #c07000; }
  .t-outsource .member-avatar { background: #eef3ff; color: #3a5abf; }
  .t-reception .member-avatar { background: #f0f5f0; color: #3a7a3a; }

  .member-info { flex: 1; min-width: 0; }
  .member-name { font-size: 13px; font-weight: 400; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .member-role { font-size: 10px; color: var(--muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .member-role.empty { color: #ccc; font-style: italic; }

  .type-badge {
    font-size: 9px; letter-spacing: 0.06em;
    padding: 2px 7px; border-radius: 20px; border: 1px solid;
    flex-shrink: 0; white-space: nowrap;
    font-family: 'Montserrat', sans-serif; font-weight: 500;
  }
  .t-staff .type-badge { color: var(--red); border-color: #f0b0b0; background: var(--red-light); }
  .t-part .type-badge { color: #c07000; border-color: #f0d090; background: #fff8ee; }
  .t-outsource .type-badge { color: #3a5abf; border-color: #b0c0f0; background: #eef3ff; }
  .t-reception .type-badge { color: #3a7a3a; border-color: #a0d0a0; background: #f0f5f0; }

  .add-member-btn {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 8px;
    border: 1.5px dashed var(--line); border-radius: 4px;
    background: none; color: var(--muted); font-size: 11px;
    cursor: pointer; margin-top: 6px;
    transition: all 0.15s;
    font-family: 'Noto Sans JP', sans-serif;
  }
  .add-member-btn:hover { border-color: var(--red); color: var(--red); background: var(--red-light); }

  /* Summary */
  .summary {
    max-width: 1140px;
    margin: 0 auto 24px;
    padding: 0 24px;
  }

  .summary-inner {
    background: var(--paper);
    border: 1px solid var(--line);
    border-radius: 4px;
    padding: 16px 28px;
    display: flex;
    gap: 0;
    align-items: center;
    flex-wrap: wrap;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }

  .summary-item { text-align: center; padding: 0 24px; }
  .summary-num {
    font-family: 'Montserrat', sans-serif;
    font-size: 28px; font-weight: 700; line-height: 1;
    color: var(--red);
  }
  .summary-label { font-size: 10px; letter-spacing: 0.1em; color: var(--muted); text-transform: uppercase; margin-top: 3px; font-family: 'Montserrat', sans-serif; }
  .summary-divider { width: 1px; height: 36px; background: var(--line); }

  /* Bottom */
  .bottom-bar {
    max-width: 1140px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
  }
  .hint { font-size: 11px; color: var(--muted); }
  .export-btn {
    padding: 10px 24px;
    border: 2px solid var(--red);
    background: transparent; color: var(--red);
    font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase;
    cursor: pointer; border-radius: 4px;
    font-family: 'Montserrat', sans-serif; font-weight: 600;
    transition: all 0.15s;
  }
  .export-btn:hover { background: var(--red); color: white; }

  /* Modal */
  .overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 200; display: none; align-items: flex-end; justify-content: center;
  }
  .overlay.open { display: flex; }
  .modal {
    background: var(--paper);
    border-radius: 16px 16px 0 0;
    width: 100%; max-width: 540px; max-height: 92vh;
    overflow-y: auto; padding-bottom: 20px;
    animation: slideUp 0.22s ease;
  }
  @media (min-width: 600px) {
    .overlay { align-items: center; }
    .modal { border-radius: 8px; max-height: 80vh; margin: 20px; }
  }
  @keyframes slideUp { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }

  .modal-bar { width: 36px; height: 4px; background: var(--line); border-radius: 2px; margin: 12px auto 0; }
  .modal-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px 14px; border-bottom: 1px solid var(--line);
  }
  .modal-title { font-size: 16px; font-weight: 500; font-family: 'Montserrat', sans-serif; }
  .modal-close {
    width: 30px; height: 30px; border-radius: 50%;
    border: 1px solid var(--line); background: none; color: var(--muted);
    font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  }
  .modal-body { padding: 18px 20px; display: flex; flex-direction: column; gap: 14px; }
  .field label {
    display: block; font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase;
    color: var(--muted); margin-bottom: 6px;
    font-family: 'Montserrat', sans-serif; font-weight: 600;
  }
  .field input, .field textarea {
    width: 100%; padding: 11px 14px;
    border: 1px solid var(--line); border-radius: 6px;
    background: var(--bg); color: var(--ink); font-size: 15px;
    font-family: 'Noto Sans JP', sans-serif; font-weight: 300;
    outline: none; transition: border-color 0.15s; -webkit-appearance: none;
  }
  .field input:focus, .field textarea:focus { border-color: var(--red); }
  .field textarea { resize: none; height: 72px; }

  .type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .type-option {
    padding: 10px; border: 1.5px solid var(--line); border-radius: 6px;
    text-align: center; font-size: 12px; cursor: pointer;
    transition: all 0.15s; background: var(--bg); color: var(--muted);
    font-family: 'Noto Sans JP', sans-serif;
  }
  .type-option.selected { border-color: var(--red); background: var(--red-light); color: var(--red); font-weight: 500; }

  .modal-actions { padding: 4px 20px 8px; display: flex; flex-direction: column; gap: 8px; }
  .btn-save {
    width: 100%; padding: 14px;
    background: var(--red); color: white;
    border: none; border-radius: 8px;
    font-size: 14px; letter-spacing: 0.05em;
    cursor: pointer; font-family: 'Noto Sans JP', sans-serif;
    transition: background 0.15s;
  }
  .btn-save:hover { background: var(--red-dark); }
  .btn-save:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-delete {
    width: 100%; padding: 11px; background: none; color: #c0392b;
    border: 1px solid #f0c0bc; border-radius: 8px;
    font-size: 13px; cursor: pointer; font-family: 'Noto Sans JP', sans-serif;
  }

  @media (max-width: 720px) {
    body { padding-bottom: 80px; }
    header { padding: 16px 20px; }
    .org { grid-template-columns: 1fr; margin: 16px auto; padding: 0 16px; gap: 14px; }
    .legend-bar { padding: 10px 16px; gap: 14px; }
    .summary { padding: 0 16px; }
    .summary-item { padding: 0 14px; }
    .bottom-bar { padding: 0 16px; flex-direction: column; align-items: stretch; }
    .export-btn { text-align: center; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">

    <div class="header-titles">
      <h1>BASI JAPAN</h1>
      <p>Organization Chart</p>
    </div>
  </div>
  <div class="save-pill" id="savePill">自動保存</div>
</header>

<div class="legend-bar">
  <div class="legend-item"><div class="legend-dot" style="background:#E8272A"></div>社員</div>
  <div class="legend-item"><div class="legend-dot" style="background:#e09000"></div>アルバイト</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3a5abf"></div>業務委託</div>
  <div class="legend-item"><div class="legend-dot" style="background:#3a7a3a"></div>受付</div>
</div>

<div class="org" id="org"></div>

<div class="summary" id="summary"></div>

<div class="bottom-bar">
  <div class="hint">メンバーをクリック／タップして編集</div>
  <button class="export-btn" onclick="exportCSV()">CSV エクスポート</button>
</div>

<!-- Modal -->
<div class="overlay" id="overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">メンバー編集</div>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-body">
      <div class="field">
        <label>名前</label>
        <input type="text" id="inputName" placeholder="名前を入力">
      </div>
      <div class="field">
        <label>役割・担当業務</label>
        <textarea id="inputRole" placeholder="例：経理、SNS管理、スケジュール調整..."></textarea>
      </div>
      <div class="field">
        <label>雇用形態</label>
        <div class="type-selector" id="typeSelector"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-save" id="btnSave" onclick="saveModal()">保存する</button>
      <button class="btn-delete" id="btnDelete" onclick="deleteModal()">このメンバーを削除</button>
    </div>
  </div>
</div>

<script>
const TYPE_CYCLE = ['staff', 'outsource', 'part', 'reception'];
const TYPE_LABEL = { staff: '社員', outsource: '業務委託', part: 'アルバイト', reception: '受付' };
const TYPE_CLASS = { staff: 't-staff', outsource: 't-outsource', part: 't-part', reception: 't-reception' };
const STORAGE_KEY = 'basi-japan-org-shared';

const BRANCHES = [
  { id: 'hq', label: 'Head Office', name: '代官山', cls: 'hq' },
  { id: 'osaka', label: 'Studio', name: '大阪', cls: 'osaka' },
  { id: 'ginza', label: 'Studio', name: '銀座', cls: 'ginza' },
];

const DEFAULT_DATA = {
  hq: [
    { id: 'm1', name: 'ASAKO', role: '', type: 'staff' },
    { id: 'm2', name: 'SAKI', role: '', type: 'staff' },
    { id: 'm3', name: 'HANAKO', role: '', type: 'staff' },
    { id: 'm4', name: 'BETTY / Hitomi', role: '', type: 'staff' },
    { id: 'm5', name: 'MASA', role: '', type: 'part' },
    { id: 'm6', name: 'MIHO', role: '', type: 'outsource' },
    { id: 'm7', name: 'CHIHO', role: '', type: 'outsource' },
    { id: 'm8', name: 'ERINA', role: '', type: 'outsource' },
    { id: 'm9', name: 'MARINA', role: '', type: 'outsource' },
  ],
  osaka: [
    { id: 'm10', name: 'YOKO', role: '', type: 'staff' },
    { id: 'm11', name: 'MAI', role: '', type: 'staff' },
    { id: 'm12', name: 'AYAKO', role: '', type: 'staff' },
    { id: 'm13', name: 'SAHO', role: '', type: 'staff' },
    { id: 'm14', name: 'YUKARI', role: '', type: 'outsource' },
    { id: 'm15', name: 'YUMIE', role: '', type: 'outsource' },
    { id: 'm16', name: 'ASA', role: '', type: 'outsource' },
  ],
  ginza: [
    { id: 'm17', name: 'MAKI', role: '受付', type: 'reception' },
    { id: 'm18', name: 'MASAE', role: '', type: 'outsource' },
    { id: 'm19', name: 'KEIKO', role: '', type: 'outsource' },
  ],
};

let data = JSON.parse(JSON.stringify(DEFAULT_DATA));
let editingBranch = null;
let editingId = null;
let selectedType = 'staff';

async function loadFromCloud() {
  try {
    const result = await window.storage.get(STORAGE_KEY, true);
    return result ? JSON.parse(result.value) : null;
  } catch(e) { return null; }
}

async function saveToCloud(d) {
  try {
    await window.storage.set(STORAGE_KEY, JSON.stringify(d), true);
    return true;
  } catch(e) { return false; }
}

function setStatus(text, saved) {
  const pill = document.getElementById('savePill');
  pill.textContent = text;
  pill.className = 'save-pill' + (saved ? ' saved' : '');
}

async function init() {
  const cloud = await loadFromCloud();
  if (cloud) data = cloud;
  else await saveToCloud(data);
  render();

  setInterval(async () => {
    const cloud = await loadFromCloud();
    if (cloud && JSON.stringify(cloud) !== JSON.stringify(data)) {
      data = cloud;
      render();
      setStatus('更新されました ✓', true);
      setTimeout(() => setStatus('自動保存', false), 3000);
    }
  }, 15000);
}

function initials(name) {
  return name.trim().split(/[\s\/]/).slice(0,2).map(p => (p[0]||'').toUpperCase()).join('');
}

function openModal(branchId, memberId) {
  editingBranch = branchId;
  editingId = memberId;
  const isNew = !memberId;
  const m = isNew ? { name: '', role: '', type: 'staff' } : data[branchId].find(x => x.id === memberId);
  document.getElementById('modalTitle').textContent = isNew ? 'メンバーを追加' : 'メンバー編集';
  document.getElementById('inputName').value = m.name;
  document.getElementById('inputRole').value = m.role;
  document.getElementById('btnDelete').style.display = isNew ? 'none' : 'block';
  selectedType = m.type;
  renderTypeSelector();
  document.getElementById('overlay').classList.add('open');
  setTimeout(() => document.getElementById('inputName').focus(), 250);
}

function renderTypeSelector() {
  const el = document.getElementById('typeSelector');
  el.innerHTML = '';
  TYPE_CYCLE.forEach(t => {
    const btn = document.createElement('div');
    btn.className = 'type-option' + (t === selectedType ? ' selected' : '');
    btn.textContent = TYPE_LABEL[t];
    btn.onclick = () => { selectedType = t; renderTypeSelector(); };
    el.appendChild(btn);
  });
}

function closeModal() {
  document.getElementById('overlay').classList.remove('open');
  editingBranch = null; editingId = null;
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('overlay')) closeModal();
}

async function saveModal() {
  const name = document.getElementById('inputName').value.trim();
  if (!name) { document.getElementById('inputName').focus(); return; }
  const role = document.getElementById('inputRole').value.trim();
  if (!editingId) {
    data[editingBranch].push({ id: 'm'+Date.now(), name, role, type: selectedType });
  } else {
    const m = data[editingBranch].find(x => x.id === editingId);
    if (m) { m.name = name; m.role = role; m.type = selectedType; }
  }
  closeModal(); render();
  setStatus('保存中...', false);
  const ok = await saveToCloud(data);
  setStatus(ok ? '保存しました ✓' : '保存失敗', ok);
  setTimeout(() => setStatus('自動保存', false), 2500);
}

async function deleteModal() {
  const name = document.getElementById('inputName').value;
  if (!editingId || !confirm(`${name} を削除しますか？`)) return;
  data[editingBranch] = data[editingBranch].filter(m => m.id !== editingId);
  closeModal(); render();
  await saveToCloud(data);
  setStatus('保存しました ✓', true);
  setTimeout(() => setStatus('自動保存', false), 2500);
}

function render() {
  renderOrg();
  renderSummary();
}

function renderOrg() {
  const orgEl = document.getElementById('org');
  orgEl.innerHTML = '';
  BRANCHES.forEach(branch => {
    const members = data[branch.id] || [];
    const counts = {};
    members.forEach(m => counts[m.type] = (counts[m.type]||0)+1);
    const countStr = Object.entries(counts).map(([t,n]) => `${TYPE_LABEL[t]} ${n}名`).join(' ／ ') || '—';

    const div = document.createElement('div');
    div.className = `branch ${branch.cls}`;
    div.innerHTML = `
      <div class="branch-header">
        <div class="branch-tag">${branch.label}</div>
        <div class="branch-name">${branch.name}</div>
        <div class="branch-count">${countStr}</div>
      </div>
    `;

    const grouped = {};
    members.forEach(m => { if (!grouped[m.type]) grouped[m.type]=[]; grouped[m.type].push(m); });
    const order = ['staff','part','reception','outsource'];

    order.forEach(type => {
      if (!grouped[type]) return;
      const sec = document.createElement('div');
      sec.className = 'section';
      sec.innerHTML = `<div class="section-label">${TYPE_LABEL[type]}</div>`;
      const membersDiv = document.createElement('div');
      membersDiv.className = 'members';
      grouped[type].forEach(m => {
        const el = document.createElement('div');
        el.className = `member ${TYPE_CLASS[m.type]}`;
        el.innerHTML = `
          <div class="member-avatar">${initials(m.name)}</div>
          <div class="member-info">
            <div class="member-name">${m.name}</div>
            <div class="member-role${m.role?'':' empty'}">${m.role||'役割未設定'}</div>
          </div>
          <div class="type-badge">${TYPE_LABEL[m.type]}</div>
        `;
        el.addEventListener('click', () => openModal(branch.id, m.id));
        membersDiv.appendChild(el);
      });
      sec.appendChild(membersDiv);
      div.appendChild(sec);
    });

    const addSec = document.createElement('div');
    addSec.className = 'section';
    const addBtn = document.createElement('button');
    addBtn.className = 'add-member-btn';
    addBtn.textContent = '＋ メンバーを追加';
    addBtn.onclick = e => { e.stopPropagation(); openModal(branch.id, null); };
    addSec.appendChild(addBtn);
    div.appendChild(addSec);
    orgEl.appendChild(div);
  });
}

function renderSummary() {
  const all = Object.values(data).flat();
  const c = { staff:0, part:0, outsource:0 };
  all.forEach(m => { if(c[m.type]!==undefined) c[m.type]++; });
  document.getElementById('summary').innerHTML = `
    <div class="summary-inner">
      <div class="summary-item"><div class="summary-num">${all.length}</div><div class="summary-label">Total</div></div>
      <div class="summary-divider"></div>
      <div class="summary-item"><div class="summary-num">${c.staff}</div><div class="summary-label">社員</div></div>
      <div class="summary-divider"></div>
      <div class="summary-item"><div class="summary-num">${c.part}</div><div class="summary-label">アルバイト</div></div>
      <div class="summary-divider"></div>
      <div class="summary-item"><div class="summary-num">${c.outsource}</div><div class="summary-label">業務委託</div></div>
      <div class="summary-divider"></div>
      <div class="summary-item"><div class="summary-num">3</div><div class="summary-label">拠点</div></div>
    </div>
  `;
}

function exportCSV() {
  const rows = [['名前','役割','雇用形態','拠点']];
  BRANCHES.forEach(b => { (data[b.id]||[]).forEach(m => rows.push([m.name, m.role, TYPE_LABEL[m.type], b.name])); });
  const csv = rows.map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'basi-japan-org.csv'; a.click();
}

init();
</script>
</body>
</html>
